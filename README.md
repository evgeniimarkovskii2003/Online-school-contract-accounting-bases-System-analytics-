# Разработка базы учета договоров онлайн-школы по подготовке к ОГЭ/ЕГЭ

## Задания ##
1. Провести системный анализ выбранной предметной области. Построить диаграммы бизнес-процессов IDEF0 AS-IS и потоков данных DFD AS-IS.
2. Провести функционально-стоимостной (функционально-временной) анализ построенных диаграмм. Сделать выводы о необходимости автоматизации. Построить диаграммы IDEF0 TO-BE и DFD TO-BE.
3. Разработать информационную модель будущей системы на базе диаграммы прецедентов (Use-Case diagram).
4. Разработать  логическую и физическую модель ERD диаграммы для разрабатываемой информационной системы.
5. Разработать схему директивного доступа к объектам базы данных для объектов взаимодействия диаграммы прецедентов.
6. Написать скрипты для создания таблиц базы данных и выдачи ролей.

## Результат ##

Контекстная диаграмма IDEF0 — диаграмма верхнего уровня иерархии, которая дает общее представление о системе. На данной диаграмме отображается один функциональный блок, все входные и выходные данные, механизмы управления и механизмы системы. На рисунке ниже представлена контекстная диаграмма IDEF0.

![image](https://github.com/user-attachments/assets/2d81e0ed-9a37-4136-a5b3-bcef6ac145cc)

В данной диаграмме входными данными являются необходимые составляющие для контроля договоров: персональные данные, запрос на приобретение курса, денежные средства (наличная оплата), расписание групп, договор, заявление о расторжении, выписка из банка (безналичная оплата).

Механизмами для данной работы являются сотрудники, а именно: менеджеры по продажам (занимается договором на начальных этапах, начиная от рекламы курсов и заканчивая подготовкой и оплатой договоров), юристы (для составления и поддержания договора на основании закона), операционные менеджеры (основная задача – внесение договора в систему и информирование о начале занятий, а также о данных для личного кабинета), служба поддержки (контролируют договоры в системе). Также механизмом является excel, который используется для записи данных клиентов, просмотра расписания групп, контроля количества оставшихся мест и др.

Управляющими механизмами являются: законы РФ, а также положения в договоре о различных гарантиях (например, возврат денег при неудачной попытке поступления на бюджет после курса при определенных выполненных учеником условиях, эти гарантии также закреплены юридически).

В статье №495 ГК РФ указано, что продавец обязан предоставить покупателю информацию о товаре, которую покупатель имеет право запрашивать.
В ФЗ №294 «О защите прав юридических лиц и индивидуальных предпринимателей при осуществлении государственного контроля (надзора) и муниципального контроля» говорится о том, что уполномоченные представители 
государственных органов вправе систематически наблюдать за исполнением обязательных требований юридическими лицами.
В статье №782 ГК РФ указано, что заказчик вправе отказаться от исполнения договора возмездного оказания услуг при условии оплаты исполнителю фактически понесенных им расходов.
В ФЗ №273 «Об образовании в Российской Федерации» хранятся обязательные пункты о реализации образовательных программ с применением электронного обучения и дистанционных образовательных технологий.

К выходным данным относятся: заключенный договор, логин и пароль от личного кабинета, платежный документ (при решении покупки курса); расторгнутый договор (при решении клиента/компании о прекращении сотрудничества), отказ от продажи курса (при решении отказать клиенту в покупке по каким-либо причинам).

Диаграмма декомпозиции первого уровня — это визуальное представление системы или процесса, которое показывает основные подпроцессы и их взаимосвязи на самом высоком уровне детализации. На рисунке ниже показана декомпозиция первого уровня диаграммы IDEF0. 

![image](https://github.com/user-attachments/assets/e81b6560-6622-4737-b4ef-38ec3ee0c494)

Для учета договоров в онлайн-школе необходим ряд следующих действий:
1) Подготовка договора. На данном этапе менеджер по продажам знакомится с клиентом и идет ознакомление клиента с программой, расписанием курсов, а также внесение данных клиента в договор.
2) Оплата и внесение данных договоров в систему. После составление договора производится его оплата и внесение данных договора в систему. 
3)  Контроль договоров в системе. После заключения договоров ведется контроль за действующими договорами, реакция на возможные расторжения, занесения кейсов в систему.  

Диаграмма декомпозиции второго уровня — это визуальное представление системы или процесса, которое показывает подкомпоненты на более детальном уровне, чем исходная диаграмма высокого уровня. Он разбивает основные функции или процессы на более мелкие, более управляемые части и помогает выявить взаимосвязи и зависимости между ними. Для автоматизации учета договоров в онлайн-школе по подготовке к ОГЭ/ЕГЭ рассмотрим декомпозицию второго уровня «Подготовка договора».

![image](https://github.com/user-attachments/assets/3b8042e5-4a6d-4181-b729-5d4da477a255)

1) Презентация курсов. На данном этапе менеджер по продажам рассказывает о возможных форматах обучения, знакомит с ценами и гарантиями.
2) Подбор группы. На данном этапе ищется или открывается группа под временные возможности клиентов.
3) Внесение данных в договор. После решения о записи и об оплате вносятся данные в договор.

Ниже представлен контекстный уровень DFD диаграммы, представленной для связи данной системы с внешними объектами 

![image](https://github.com/user-attachments/assets/d007521b-1cc8-4eef-aaca-61be78a0b40c)

Внешними сущностями для выбранной системы являются:
 1. Клиент – посетитель, который предоставляет образовательной организации свои персональные данные, денежные средства/выписку из банка, договор, а также может подать заявление о расторжении при необходимости. В онлайн-школе клиенту предоставляют информацию о курсах, при покупке курса заключенный договор, платежный документ и доступ к личному кабинету. При желании прекратить договор дают соглашение о расторжении. В случае отказа от продажи курса выдается уведомление с причиной отказа. 
2. Руководство предоставляет различные положения о договорах и гарантиях, получает информацию о заключенных договорах (об их количестве, % заключенных договоров с полной оплатой и т. д.)

На рисунке ниже изображена контекстная диаграмма DFD первого уровня.

![image](https://github.com/user-attachments/assets/2e7436a6-3a10-4439-9ceb-40302147806a)

Все работы, представленные на декомпозиции первого уровня диаграммы IDEF0, продублированы на диаграмме декомпозиции первого уровня DFD.
На диаграмме представлены следующие накопители:
1) Наличие мест в группе – содержит места в открытых группах для рассмотрения записи клиентом.
2)  Архив клиентов – данные о клиентах, которые расторгли договор или срок действия их договора истек.
3) Персональные данные – данные действующих клиентов.
4) Презентации договоров – информация о форматах курсов, стоимости и др.	

### Функционально-временной анализ построенных диаграмм ###

Стоимость работы измерялась в человеко-минутах, потраченных на одного гражданина. Стоимость каждой работы изображена в левом нижнем углу блока-процесса.
Учёт договоров в онлайн школе по подготовке к ОГЭ/ЕГЭ был рассмотрен в диаграммах IDEF0 и DFD. Можно сделать вывод о том, что данный бизнес-процесс надо автоматизировать для сокращения времени работы, облегчив задачу. Сейчас общее время составляет 130 минут. Вся информация будет храниться в отдельных накопителях для удобства поиска, передачи или доработки в дальнейшем.

Ниже представлена контекстная диаграмма учёта договоров в онлайн-школе по подготовке к ОГЭ/ЕГЭ. Время, затраченное на процессы, измеряется в минутах, 90 минут.

![image](https://github.com/user-attachments/assets/38ff333d-0229-4275-a4d4-2a7de1da23d6)

В таблице представлены различия между контекстными диаграммами IDEF0 AS-IS и IDEF0 TO-BE.
| Изменённый элемент | IDEF0 AS-IS | IDEF0 TO-BE             |
|--------------------|-------------|--------------------------|
| Механизм           | Excel       | Информационная система  |

Разница во времени выполнения процесса равна: 
130 – 90 = 40 (минут на человека).

Далее представлена декомпозиция первого уровня диаграммы IDEF0 TO-BE.

![image](https://github.com/user-attachments/assets/1f08ab1c-512f-4f56-83c1-3ed1871155f0)

Различие между двумя диаграммами заключается в замене механизма excel на информационную систему.
Информационная система используется в следующих процессах:
1) в процессе «подготовка договоров» с помощью информационной системы автоматически по введенным данным подбирается группа и создается электронная версия договора;
2) в процессе «оплата и внесение данных договоров в систему» за счет информационной системы вносится оплачиваемая клиентом часть, а также происходит внесение данных клиента в базу данных; 
3) в процессе «контроль договоров в системе» в базу данных вносятся данные о прекращении действия договоров (дата, время, № заявления и др.), а также информация о последующих оплатах, фиксируется задолженность.

В следующей таблице представлены различия между декомпозицией первого уровня диаграммы IDEF0 AS-IS и декомпозиции первого уровня диаграммы IDEF0 TO-BE.

| Изменённый элемент | IDEF0 AS-IS | IDEF0 TO-BE             |
|--------------------|-------------|--------------------------|
| Механизм           | Excel       | Информационная система  |

Разница во времени выполнения процессов:
1) Подготовка договоров: 60 – 40 = 20 минут.
2) Оплата и внесение данных договоров в систему: 20 – 15 = 5 минут.
3) Контроль договоров в системе: 50 – 35 = 15 минут.

Декомпозиция второго уровня диаграммы IDEF0 TO-BE представлена ниже на рисунке.

![image](https://github.com/user-attachments/assets/798b4d38-5af3-4a3f-a6ce-ba7dfb1c21b6)

Различие между двумя диаграммами заключается в замене механизма excel на информационную систему.
Информационная система используется во время процессов «подбор группы» и «внесение данных в договор». При подборе группы в систему вводятся временные возможности клиентов, исходя из которых выводятся возможные варианты и идет выбор группы. После внесения персональных данных автоматически создается электронная версия договора.

В таблице ниже представлены различия между декомпозициями второго уровня диаграммы IDEF0 AS-IS и IDEF0 TO-BE

| Изменённый элемент | IDEF0 AS-IS | IDEF0 TO-BE             |
|--------------------|-------------|--------------------------|
| Механизм           | Excel       | Информационная система  |

Разница во времени выполнения процессов: 
Подбор группы: 15 – 5 = 10 минут.
Внесение данных в договор: 15 – 5 = 10 минут. 

Далее представлена диаграмма контекстного уровня DFD TO-BE.

![image](https://github.com/user-attachments/assets/ec9d5ca2-6b88-4125-a653-b93f21c5bc2c)

Разница во времени выполнения процесса равна:
130 – 90 = 40 (минут на человека).

На рисунке ниже изображена диаграмма декомпозиции первого уровня DFD TO-BE.

![image](https://github.com/user-attachments/assets/412a1f16-28fa-4119-b923-fc03cf6e1ba5)

Различие заключается в том, что накопители, представленные записями в excel, заменяются на электронные таблицы, которые входят в базу данных учета договоров.

Различия данных диаграмм представлены ниже в таблице.

| Изменённый элемент | IDEF0 AS-IS | IDEF0 TO-BE             |
|--------------------|-------------|--------------------------|
| Накопитель           | Наличие мест в группе       | Таблица с наличием мест в группе  |
| Накопитель           | Персональные данные       | Таблица с персональными данными  |

Разница во времени выполнения различных процессов: 
1) Подготовка договоров: 60 – 40 = 20 минут.
2) Оплата и внесение данных договоров в систему: 20 – 15 = 5 минут.
3) Контроль договоров в системе: 50 – 35 = 15 минут.

В ходе проведения функционально-временного анализа с построением DFD и IDEF0 диаграмм TO-BE время выполнения процессов значительно сокращено с учетом использовании информационной системы. Разница во времени составляет 130 – 90 = 40 минут.

### Диаграмма прецедентов (Use-Case diagram) ###

Анализ области применения и планирование являются первичными стадиями в разработке программного решения, где одним из ключевых результатов является создание диаграммы использования (Use Case). 

Use-Case диаграмма представлена на рисунках ниже (1 и 2 части).

![image](https://github.com/user-attachments/assets/0a366fc9-6153-4dee-9442-906e4c32060a)

![image](https://github.com/user-attachments/assets/5037801e-4293-4ad0-89a5-30b8d7d83376)

Для предотвращения выхода системы из строя, написаны успешный сценарий и сценарий расширения.

**Основной сценарий «Запрос консультации»**

| Шаг | Действие                                                                 |
|-----|--------------------------------------------------------------------------|
| 1   | Клиент использует сайт для запроса консультации                         |
| 2   | Система открывает меню с вариантами времени и вводом данных             |
| 3   | Клиент выбирает время, вводит свои данные и оставляет заявку            |
| 4   | Система успешно завершает оформление заявки                             |
| 5   | Клиент получает индивидуальный номер заявки                             |

**Сценарий расширения «Запрос консультации»**

| Сценарий | Шаг | Действие                                                                                      |
|----------|-----|-----------------------------------------------------------------------------------------------|
| a*       | 1   | Клиент вводит номер заявки                                                                    |
|          | 2   | Система предлагает новые даты и форму ввода                                                   |
|          | 3   | Система завершает оформление                                                                  |
|          | 4   | Клиент получает новый номер заявки                                                            |
| b*       | 1   | Система уведомляет клиента о невозможности консультации и отправляет ссылку                   |
|          | 2   | Система отменяет консультацию                                                                 |
| c*       | 1   | Клиент вводит номер консультации в разделе «Отмена»                                           |
|          | 2   | Система отменяет консультацию                                                                 |
| d*       | 1   | Система уведомляет клиента о причине отмены                                                  |
|          | 2   | Система отменяет консультацию                                                                 |

**Основной сценарий «Запрос на приобретение курса»**

| Шаг | Действие                                                                 |
|-----|--------------------------------------------------------------------------|
| 1   | Клиент использует сайт для запроса на приобретение курса                |
| 2   | Система открывает меню с вариантами времени и вводом данных             |
| 3   | Клиент вводит данные и оставляет заявку                                 |
| 4   | Система завершает оформление заявки                                     |
| 5   | Клиент получает индивидуальный номер заявки                             |

**Основной сценарий «Составление договора»**
| Шаг | Действие                                                                 |
|-----|--------------------------------------------------------------------------|
| 1   | Система копирует данные из заявки                                       |
| 2   | Вводятся оставшиеся данные (паспорт, формат, стоимость и т.д.)          |
| 3   | Система составляет договор                                               |
| 4   | Договор отправляется на печать или клиенту по почте                     |

**Основной сценарий «Составление договора»**
| Шаг | Действие                                                                 |
|-----|--------------------------------------------------------------------------|
| 1   | Система копирует данные из заявки                                       |
| 2   | Вводятся оставшиеся данные (паспорт, формат, стоимость и т.д.)          |
| 3   | Система составляет договор                                               |
| 4   | Договор отправляется на печать или клиенту по почте                     |

**Основной сценарий «Запрос расторжения договора»**
| Шаг | Действие                                                                 |
|-----|--------------------------------------------------------------------------|
| 1   | Клиент отправляет запрос на расторжение через систему                   |
| 2   | Служба поддержки фиксирует причину                                      |
| 3   | Система отправляет данные преподавателю и руководителю                 |
| 4   | Преподаватель обновляет статус по расторжению                          |
| 5   | Клиенту приходит уведомление о результате                              |

**Основной сценарий «Запрос получения информации»**
| Шаг | Действие                                                                 |
|-----|--------------------------------------------------------------------------|
| 1   | Клиент отправляет запрос на получение информации                        |
| 2   | Служба поддержки уточняет детали                                         |
| 3   | Система отправляет запрос преподавателю                                 |
| 4   | Преподаватель заполняет данные                                           |
| 5   | Система передаёт их службе поддержки                                    |
| 6   | Служба поддержки связывается с клиентом и отмечает статус               |
| 7   | Система уведомляет клиента и преподавателя о закрытии запроса          |

**Основной сценарий «Запрос изменения позиций договора»**
| Шаг | Действие                                                                 |
|-----|--------------------------------------------------------------------------|
| 1   | Клиент отправляет запрос изменения позиций договора                     |
| 2   | Служба поддержки уточняет детали                                         |
| 3   | Система отправляет данные руководителю                                  |
| 4   | Руководитель вводит новые предложения                                   |
| 5   | Служба поддержки передаёт их клиенту                                    |
| 6   | Клиент принимает решение                                                |
| 7   | Уведомление о необходимости доплаты/возврата                            |
| 8   | Система уведомляет клиента и руководителя о закрытии запроса           |

**Основной сценарий «Отправка данных»**
| Шаг | Действие                                                                 |
|-----|--------------------------------------------------------------------------|
| 1   | Операционный менеджер вводит логин и пароль                              |
| 2   | Система за день до старта отправляет доступ клиенту и напоминание       |

### Проектирование базы данных ###

ER-модель — это модель данных, используемая для описания концептуальных схем предметной области.

**Логическая модель**

Для построения диаграммы были выбраны следующие сущности: клиенты, ученики, договоры, группы, курсы, преподаватели, форматы, стоимости форматов, результаты учеников, разделы курсов, занятия, лицензия организации, наборы документов, претензии, потенциальные расторжения, счета, квитанции.

В сущности «клиенты» внесена основная информация о родственниках ученика, такая как: ФИО, дата рождения, контактные данные (номер телефона, электронная почта), согласие на использование персональных данных (отметка о подписи). Первичным ключом является – ID клиента. Также присутствует вторичный ключ – наборы документов.

В сущности «ученики» содержится основная информация об учениках: фамилия, имя, дата рождения, контактные данные (номер телефона, электронная почта), логин и пароль от личного кабинета, количество посещений.  Первичный ключ – ID ученика. Важно отметить, что клиенты могут не давать согласие на некоторые персональные данные ученика, сделаем возможным для таких полей значение NULL.

Сущность «договоры» содержит начало действия и конец действия договора, а также вторичные ключи: ID клиента, ID ученика, номер группы. Первичным ключом является номер договора. 
Сущность «группы» включает в себя старт и окончание набора группы. Также вторичные ключи: ID преподавателя, ID курса, ID формата. Номер группы – первичный ключ.

Сущность «курсы» содержит описание и сложность курса, а также номер класса. ID курса – первичный ключ.

В сущности «преподаватели» содержится основная информация о преподавателях: фамилия, имя, дата рождения, контактные данные (номер телефона, электронная почта), логин и пароль от личного кабинета. Первичный ключ – ID преподавателя. А также вторичные ключи: ID набора документов и ID лицензии организации.

Сущность «форматы» включает в себя название формата, количество занятий, длительность. ID формата – первичный ключ.

Сущность «стоимости форматов» дату введения стоимости и саму стоимость. ID стоимости формата – первичный ключ. ID формата – вторичный ключ.

В сущности «результаты учеников» содержится оценка, название контрольной точки, вторичные ключи – ID ученика, ID курса. Первичный ключ – ID результата.

В сущности «разделы курсов» внесена основная информация о разделах курса, которые проходятся на курсе: наименование и описание раздела. ID раздела курса – первичный ключ. ID курса – вторичный ключ.

Сущность «занятия» включает в себя тему и время проведения занятия. Первичный ключ – ID занятия. Вторичный ключ – ID раздела курса. 

В сущности «лицензия организации» содержится первичный ключ - ID лицензии организации, а также поля: наименование лицензирующего органа, номер лицензии, дата предоставления лицензии.

Сущность «наборы документов» содержит в себе документы необходимые для преподавателя и клиента, а именно: наименование документа, данные документа, номер ИНН, дата выдачи документа, наименование выдающего органа, СНИЛС. ID набора документов – первичный ключ. Клиент вправе не предоставлять некоторые документы, в таком случае поля будут заполнены, как NULL.

Сущность «претензии» содержит в себе наименование причины, описание проблемы, итоговый статус. ID претензии – первичный ключ, ID договора – вторичный ключ.

Сущность «потенциальность расторжения» включает в себя следующие поля: необходимость возврата средств (отметка о том будет ли произведен возврат), тип документа, путь к файлу документа, сумма возврата, способ возврата, дата возврата, статус расторжения. ID потенциального расторжения – первичный ключ, ID претензии – вторичный ключ. Здесь важно пометить, что, если претензия не заканчивается расторжением, то все поля, связанные с возвратом средств будут NULL в данной сущности, а в статусе расторжения будет указано, что договор не расторгнут.

Сущность «счета» содержит первичный ключ – ID счета, вторичный ключ – номер договора, а также поле: кол-во оплат.

Сущность «квитанции» включает в себя дату и время оплаты, сумму оплаты, а также способ оплаты. Первичный ключ – ID квитанции, вторичный ключ – ID счета.

Далее на рисунке представлена ER-диаграмма логического уровня, реализующая учет договоров онлайн школы по подготовке к ОГЭ/ЕГЭ.

![image](https://github.com/user-attachments/assets/8620f0ae-5f60-43f6-ba27-d0e523875da4)

**Физическая модель данных**

Для нашей модели данных будем использовать СУБД PostgreSQL. К основным преимуществам выбранной СУБД можно отнести:
1.	Расширенные возможности, включая полнотекстовый поиск, поддержку JSON и многие другие расширения. 
2.	Высокая надежность и целостность данных.
3.	Расширяемость (поддержка и создание пользовательских типов данных, функций и расширений). 

Физическая ER-диаграмма показана ниже.

![image](https://github.com/user-attachments/assets/a8d75e06-946e-411f-9447-bf8035dc0436)

Далее напишем скрипт для создания базы данных.

```sql
CREATE TABLE IF NOT EXISTS public.document_sets (
    document_set_id SERIAL PRIMARY KEY,
    document_name VARCHAR(255) NOT NULL,
    document_data INT NOT NULL,
    inn_number INT NOT NULL,
    issue_date DATE NOT NULL,
    issuing_organization VARCHAR(255),
    snils INT NOT NULL
);

CREATE TABLE IF NOT EXISTS public.organization_licenses (
    license_id SERIAL PRIMARY KEY,
    licensing_organization VARCHAR(255) NOT NULL,
    license_number INT NOT NULL,
    issue_date DATE NOT NULL
);

CREATE TABLE IF NOT EXISTS public.teachers (
    teacher_id SERIAL PRIMARY KEY,
    document_set_id INT NOT NULL,
    license_id INT NOT NULL,
    surname VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    birth_date DATE NOT NULL,
    phone_number VARCHAR(15) NOT NULL,
    e_mail VARCHAR(255),
    login VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    FOREIGN KEY (document_set_id) REFERENCES public.document_sets(document_set_id)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION,
    FOREIGN KEY (license_id) REFERENCES public.organization_licenses(license_id)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION
);

CREATE TABLE IF NOT EXISTS public.clients (
    client_id SERIAL PRIMARY KEY,
    document_set_id INT NOT NULL,
    surname VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    patronymic VARCHAR(255),
    birth_date DATE NOT NULL,
    phone_number VARCHAR(15) NOT NULL,
    e_mail VARCHAR(255),
    consent_to_data_processing BOOLEAN NOT NULL,
    FOREIGN KEY (document_set_id) REFERENCES public.document_sets(document_set_id)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION
);

CREATE TABLE IF NOT EXISTS public.students (
    student_id SERIAL PRIMARY KEY,
    surname VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    birth_date DATE NOT NULL,
    phone_number VARCHAR(15),
    e_mail VARCHAR(255),
    login VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    attendance_count INT NOT NULL
);

CREATE TABLE IF NOT EXISTS public.courses (
    course_id SERIAL PRIMARY KEY,
    course_description VARCHAR(255) NOT NULL,
    course_difficulty VARCHAR(255) NOT NULL,
    class_number INT NOT NULL
);

CREATE TABLE IF NOT EXISTS public.course_sections (
    section_id SERIAL PRIMARY KEY,
    course_id INT NOT NULL,
    section_description VARCHAR(255),
    section_name VARCHAR(255) NOT NULL,
    FOREIGN KEY (course_id) REFERENCES public.courses(course_id)
        ON UPDATE NO ACTION 
        ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS public.formats (
    format_id SERIAL PRIMARY KEY,
    format_name VARCHAR(255) NOT NULL,
    number_of_lessons INT NOT NULL,
    lesson_duration INT NOT NULL
);

CREATE TABLE IF NOT EXISTS public.format_costs (
    cost_id SERIAL PRIMARY KEY,
    format_id INT NOT NULL,
    cost_date DATE NOT NULL,
    cost DECIMAL NOT NULL,
    FOREIGN KEY (format_id) REFERENCES public.formats(format_id)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION
);

CREATE TABLE IF NOT EXISTS public.groups (
    group_number SERIAL PRIMARY KEY,
    teacher_id INT NOT NULL,
    course_id INT NOT NULL,
    format_id INT NOT NULL,
    start_recruitment DATE NOT NULL,
    end_recruitment DATE,
    FOREIGN KEY (teacher_id) REFERENCES public.teachers(teacher_id)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION,
    FOREIGN KEY (course_id) REFERENCES public.courses(course_id)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION,
    FOREIGN KEY (format_id) REFERENCES public.formats(format_id)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION
);

CREATE TABLE IF NOT EXISTS public.contracts (
    contract_number SERIAL PRIMARY KEY,
    client_id INT NOT NULL,
    student_id INT NOT NULL,
    group_number INT NOT NULL,
    validity_from DATE NOT NULL,
    validity_to DATE NOT NULL,
    FOREIGN KEY (client_id) REFERENCES public.clients(client_id)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION,
    FOREIGN KEY (student_id) REFERENCES public.students(student_id)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION,
    FOREIGN KEY (group_number) REFERENCES public.groups(group_number)
        ON UPDATE NO ACTION 
        ON DELETE NO ACTION
);

CREATE TABLE IF NOT EXISTS public.student_results (
    result_id SERIAL PRIMARY KEY,
    student_id INT NOT NULL,
    section_id INT NOT NULL,
    grade INT NOT NULL,
    checkpoint_name VARCHAR(255) NOT NULL,
    FOREIGN KEY (student_id) REFERENCES public.students(student_id)
        ON UPDATE NO ACTION 
        ON DELETE CASCADE,
    FOREIGN KEY (section_id) REFERENCES public.course_sections(section_id)
        ON UPDATE NO ACTION 
        ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS public.lessons (
    lesson_id SERIAL PRIMARY KEY,
    section_id INT NOT NULL,
    lesson_topic VARCHAR(255) NOT NULL,
    lesson_time TIMESTAMP NOT NULL,
    FOREIGN KEY (section_id) REFERENCES public.course_sections(section_id)
        ON UPDATE NO ACTION 
        ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS public.invoices (
    invoice_id SERIAL PRIMARY KEY,
    contract_number INT NOT NULL,
    payment_count INT NOT NULL,
    FOREIGN KEY (contract_number) REFERENCES public.contracts(contract_number)
        ON UPDATE NO ACTION 
        ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS public.receipts (
    receipt_id SERIAL PRIMARY KEY,
    invoice_id INT NOT NULL,
    payment_time TIMESTAMP NOT NULL,
    payment_amount DECIMAL NOT NULL,
    payment_method VARCHAR(255) NOT NULL,
    FOREIGN KEY (invoice_id) REFERENCES public.invoices(invoice_id)
        ON UPDATE NO ACTION 
        ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS public.claims (
    claim_id SERIAL PRIMARY KEY,
    contract_number INT NOT NULL,
    reason VARCHAR(255) NOT NULL,
    issue_description VARCHAR(255) NOT NULL,
    status VARCHAR(255) NOT NULL,
    FOREIGN KEY (contract_number) REFERENCES public.contracts(contract_number)
        ON UPDATE NO ACTION 
        ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS public.potential_terminations (
    termination_id SERIAL PRIMARY KEY,
    claim_id INT NOT NULL,
    refund_required BOOLEAN NOT NULL,
    document_type VARCHAR(255),
    document_path VARCHAR(255),
    refund_amount DECIMAL,
    refund_method VARCHAR(255),
    refund_date DATE,
    termination_status VARCHAR(255) NOT NULL,
    FOREIGN KEY (claim_id) REFERENCES public.claims(claim_id)
        ON UPDATE NO ACTION 
        ON DELETE CASCADE
);
```

### Схема директивного доступа к объектам базы данных ###

Сотрудники компании, имеющие непосредственный доступ к базе данных:
1.	Руководитель
2.	Операционный менеджер
3.	Менеджер по продажам
4.	Маркетинговый отдел
5.	Преподаватель
6.	Служба поддержки

Определение области работы сотрудников базы данных заключается в контроле уровней доступа сотрудника к изменению, редактированию или удалению данных с помощью распределения создания ролей директивного доступа. Каждый из сотрудников, представленный на диаграмме прецедентов, имеющий непосредственный доступ к базе данных, имеет свою схему доступа. А при создании учетной записи для нового сотрудника заранее определяется его роль на сервере СУБД.

Далее представлены роли для сотрудников.

Руководитель будет иметь доступ C, R, U, D для всех данных, так как он контролирует весь процесс и принимает ключевые решения. Руководитель несет ответственность за управление ресурсами организации, включая кадровые, финансовые и информационные ресурсы. У руководителя есть доступ Delete ко всем сущностям, чтобы в случае ошибок при добавлении или необходимости удалить какие-то данные по какой-либо причине, это можно было сделать.

**Схема доступа роли "Руководитель"**

| Таблица                    | Столбец | Представление                        | Уровни доступа |
|----------------------------|---------|--------------------------------------|----------------|
| Клиенты                   | Все     | Информация о клиенте                | C, R, U, D     |
| Ученики                   | Все     | Информация об ученике и его посещениях | C, R, U, D  |
| Договоры                  | Все     | Информация о документах             | C, R, U, D     |
| Группы                    | Все     | Информация об организации курсов    | C, R, U, D     |
| Курсы                     | Все     | Информация о курсах                 | C, R, U, D     |
| Разделы курсов            | Все     | Информация о курсах                 | C, R, U, D     |
| Занятия                   | Все     | Информация о курсах                 | C, R, U, D     |
| Результаты учеников       | Все     | Информация о курсах                 | C, R, U, D     |
| Преподаватели             | Все     | Информация о преподавателе          | C, R, U, D     |
| Форматы                   | Все     | Информация об организации курсов    | C, R, U, D     |
| Стоимости форматов        | Все     | Информация о финансах               | C, R, U, D     |
| Лицензия организации      | Все     | Информация о документах             | C, R, U, D     |
| Счета                     | Все     | Информация о финансах               | C, R, U, D     |
| Квитанции                 | Все     | Информация о финансах               | C, R, U, D     |
| Наборы документов         | Все     | Информация о документах             | C, R, U, D     |
| Претензии                 | Все     | Информация о недовольствии клиента  | C, R, U, D     |
| Потенциальные расторжения | Все     | Информация о финансах               | C, R, U, D     |

К основным задачам операционного менеджера относиться работа с договором после его заключения (подключения ученика к личному кабинету, изменение/удаление данных договоров и др.). Для этих целей ему необходим доступ к сущностям: клиенты, ученики, договоры, группы, курсы, преподаватели, форматы.

**Схема доступа роли "Операционный менеджер":**

| Таблица        | Столбец | Представление                        | Уровни доступа |
|----------------|---------|--------------------------------------|----------------|
| Клиенты        | Все     | Информация о клиенте                | R, U           |
| Ученики        | Все     | Информация об ученике и его посещениях | R, U         |
| Договоры       | Все     | Информация о документах             | R, U           |
| Группы         | Все     | Информация об организации курсов    | R              |
| Курсы          | Все     | Информация о курсах                 | R              |
| Преподаватели  | Все     | Информация о преподавателе          | R              |
| Форматы        | Все     | Информация об организации курсов    | R              |

Менеджер по продажам занимается консультированием, составлением договора, открытием групп и оформлением клиента, поэтому имеет различный доступ ко всем сущностям, чтобы была возможность в составлении договора, сориентировать клиента по любым вопросам и внести необходимые данные. Менеджеру по продажам разрешен доступ Delete для групп в случае, если по какой-то причине планируемая группа не открылась. В случаях удаления других данных менеджер по продажам должен обратиться к руководителю.

**Схема доступа роли «Менеджер по продажам»:**

| Таблица                    | Столбец | Представление                        | Уровни доступа |
|----------------------------|---------|--------------------------------------|----------------|
| Клиенты                   | Все     | Информация о клиенте                | C, R           |
| Ученики                   | Все     | Информация об ученике и его посещениях | C, R         |
| Договоры                  | Все     | Информация о документах             | C, R           |
| Группы                    | Все     | Информация об организации курсов    | C, R, U, D     |
| Курсы                     | Все     | Информация о курсах                 | R              |
| Разделы курсов            | Все     | Информация о курсах                 | R              |
| Занятия                   | Все     | Информация о курсах                 | R              |
| Результаты учеников       | Все     | Информация о курсах                 | R              |
| Преподаватели             | Все     | Информация о преподавателе          | R              |
| Форматы                   | Все     | Информация об организации курсов    | R              |
| Стоимости форматов        | Все     | Информация о финансах               | R              |
| Лицензия организации      | Все     | Информация о документах             | R              |
| Счета                     | Все     | Информация о финансах               | C, R, U        |
| Квитанции                 | Все     | Информация о финансах               | C, R, U        |
| Наборы документов         | Все     | Информация о документах             | C, R, U        |
| Претензии                 | Все     | Информация о недовольствии клиента  | C, R, U        |
| Потенциальные расторжения | Все     | Информация о финансах               | C, R, U        |

Маркетинговый отдел занимается анализом конкурентов на рынке, разработки рекламных акций, новых форматов обучения и курсов (не касается содержания), а также стоимости на них. Для маркетингового отдела доступны следующие сущности: курсы, результаты учеников, форматы и стоимости форматов. 

**Схема доступа роли «Маркетинговый отдел»:**

| Таблица              | Столбец | Представление                     | Уровни доступа |
|----------------------|---------|-----------------------------------|----------------|
| Курсы               | Все     | Информация о курсах              | C, R, U        |
| Результаты учеников | Все     | Информация о курсах              | R              |
| Форматы             | Все     | Информация об организации курсов | C, R, U        |
| Стоимости форматов  | Все     | Информация о финансах            | C, R, U, D     |

Преподаватели занимаются разработкой содержания курсов, а также их преподаванием, в том числе контроль за учениками и предоставление обратной связи клиенту через службы поддержки. Преподавателю доступны следующие сущности: клиенты, ученики, группы, курсы, разделы курсов, занятия, результаты учеников, форматы.

**Схема доступа роли «Преподаватель»:**

| Таблица                    | Столбец | Представление                        | Уровни доступа |
|----------------------------|---------|--------------------------------------|----------------|
| Клиенты                   | Все     | Информация о клиенте                | R              |
| Ученики                   | Все     | Информация об ученике и его посещениях | R           |
| Группы                    | Все     | Информация об организации курсов    | R              |
| Курсы                     | Все     | Информация о курсах                 | R              |
| Разделы курсов            | Все     | Информация о курсах                 | C, R, U, D     |
| Занятия                   | Все     | Информация о курсах                 | C, R, U, D     |
| Результаты учеников       | Все     | Информация о курсах                 | C, R, U, D     |
| Форматы                   | Все     | Информация об организации курсов    | R              |

Служба поддержки отвечает за связь множества ролей, например, если преподавателю нужно обратиться к клиенту, то необходимо будет оставить заявку в службе поддержки. Также служба поддержки принимает запросы от клиентов и ставит различные статусы (например, описание причины и проблемы, в сущности «Претензии»). Для службы поддержки доступны следующие сущности: клиенты, ученики, договоры, группы, курсы, результаты учеников, преподаватели, форматы, стоимости форматов, счета, квитанции, претензии, потенциальные расторжения.

**Схема доступа роли «Служба поддержки»:**

| Таблица                    | Столбец | Представление                        | Уровни доступа |
|----------------------------|---------|--------------------------------------|----------------|
| Клиенты                   | Все     | Информация о клиенте                | R              |
| Ученики                   | Все     | Информация об ученике и его посещениях | R           |
| Договоры                  | Все     | Информация о документах             | R              |
| Группы                    | Все     | Информация об организации курсов    | R              |
| Курсы                     | Все     | Информация о курсах                 | R              |
| Результаты учеников       | Все     | Информация о курсах                 | R              |
| Преподаватели             | Все     | Информация о преподавателе          | R              |
| Форматы                   | Все     | Информация об организации курсов    | R              |
| Стоимости форматов        | Все     | Информация о финансах               | R              |
| Счета                     | Все     | Информация о финансах               | R              |
| Квитанции                 | Все     | Информация о финансах               | R              |
| Претензии                 | Все     | Информация о недовольствии клиента  | C, R, U        |
| Потенциальные расторжения | Все     | Информация о финансах               | C, R, U        |

Далее представлен скрипт для выдачи ролей сотрудникам.

```sql
CREATE ROLE director;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO director;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO director;

CREATE ROLE operations_manager;
GRANT SELECT, UPDATE ON TABLE clients, students, contracts TO operations_manager;
GRANT SELECT ON TABLE groups, courses, teachers, formats TO operations_manager;

CREATE ROLE sales_manager;
GRANT SELECT, INSERT ON TABLE clients, students, contracts, groups TO sales_manager;
GRANT SELECT ON TABLE courses, course_sections, lessons, student_results, teachers, formats, format_costs, organization_licenses TO sales_manager;
GRANT SELECT, INSERT, UPDATE ON TABLE invoices, receipts, document_sets, claims, potential_terminations TO sales_manager;

CREATE ROLE marketing_department;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE format_costs TO marketing_department;
GRANT SELECT, INSERT, UPDATE ON TABLE courses, formats TO marketing_department;
GRANT SELECT ON TABLE student_results TO marketing_department;

CREATE ROLE teacher;
GRANT SELECT ON TABLE clients, students, groups, courses, formats TO teacher;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE course_sections, lessons, student_results TO teacher;

CREATE ROLE support_service;
GRANT SELECT ON TABLE clients, students, contracts, groups, courses, teachers, formats, format_costs, invoices, receipts TO support_service;
GRANT SELECT, INSERT, UPDATE ON TABLE claims, potential_terminations TO support_service;
```















